"use strict";var CrussaderWC=(()=>{var L=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var N=(a,d,g,s)=>{if(d&&typeof d=="object"||typeof d=="function")for(let o of A(d))!j.call(a,o)&&o!==g&&L(a,o,{get:()=>d[o],enumerable:!(s=T(d,o))||s.enumerable});return a};var B=a=>N(L({},"__esModule",{value:!0}),a);var P={};(()=>{if(typeof window>"u"||window.__crussaderChatLoaded)return;window.__crussaderChatLoaded=!0;let a=[];window.crussaderChat=(...s)=>a.push(s);function d(s){document.readyState==="complete"||document.readyState==="interactive"?setTimeout(s,0):document.addEventListener("DOMContentLoaded",s)}function g(s){return(window.__CRUSSADER_API_BASE__||"")+s}d(()=>{let o=(document.currentScript||document.querySelector('script[src*="wc.js"]'))?.getAttribute("data-key")||"demo-public-key-123",b=null,f=null,l={async bootstrap(e){let t=await fetch(g(`/api/webchat/bootstrap?key=${encodeURIComponent(e)}`));if(!t.ok)throw new Error("bootstrap error");return t.json()},sessionLSKey(e){return`crussader:webchat:session:${e}`},readSessionFromLS(e){try{return JSON.parse(localStorage.getItem(l.sessionLSKey(e))||"null")}catch{return null}},writeSessionToLS(e,t){try{localStorage.setItem(l.sessionLSKey(e),JSON.stringify(t))}catch{}},async ensureSessionByKey(e){let t=l.readSessionFromLS(e),n=t?.visitorId||(crypto?.randomUUID?.()??String(Date.now()));if(t?.sessionId&&t?.siteId)return b=t.siteId,f=t.sessionId,{siteId:t.siteId,sessionId:t.sessionId};let c=await fetch(g("/api/webchat/sessions"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:e,visitorId:n,meta:{ua:navigator.userAgent,lang:navigator.language,ref:document.referrer}})}),p=await c.json();if(!c.ok)throw new Error(p?.error||"session error");return l.writeSessionToLS(e,{visitorId:n,sessionId:p.sessionId,siteId:p.siteId}),b=p.siteId,f=p.sessionId,{siteId:b,sessionId:f}},async sendUserMessage(e){if(!b||!f)throw new Error("No session");let t=await fetch(g("/api/webchat/messages"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({siteId:b,sessionId:f,role:"USER",text:e})}),n=await t.json();if(!t.ok)throw new Error(n?.error||"send error");return n}},u=document.createElement("div");u.id="crussader-chat-host",u.style.position="fixed",u.style.zIndex="2147483647",u.style.bottom="20px",u.style.right="20px",document.body.appendChild(u);let w=u.attachShadow({mode:"open"}),x="#7c3aed",I=document.createElement("style");I.textContent=`
      :host { all: initial; }
      .btn { width:56px; height:56px; border-radius:9999px; display:grid; place-items:center; background:${x};
             color:#fff; border:none; box-shadow:0 8px 24px rgba(0,0,0,.18); cursor:pointer; }
      .panel { position:fixed; right:0; bottom:86px; width:min(360px,90vw); height:520px; background:#fff;
               border-radius:16px; box-shadow:0 16px 48px rgba(0,0,0,.16); border:1px solid rgba(0,0,0,.06);
               display:none; overflow:hidden; }
      .header { height:56px; background:${x}; color:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 14px; font:600 14px system-ui,sans-serif; }
      .body { display:flex; flex-direction:column; height:calc(100% - 56px); background:#fafafa; }
      .msgs { flex:1; overflow:auto; padding:12px; font:14px/1.4 system-ui,sans-serif; color:#111; }
      .row { margin:8px 0; display:flex; }
      .row.user { justify-content:flex-end; }
      .bubble { max-width:80%; padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; white-space:pre-wrap; }
      .row.user .bubble { background:#eef2ff; }
      .input { display:flex; gap:8px; padding:10px; background:#fff; border-top:1px solid #eee; }
      .input input { flex:1; border:1px solid #e5e7eb; border-radius:10px; padding:10px; font:14px system-ui,sans-serif; }
      .input button { background:${x}; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; }
      .close { background:rgba(255,255,255,.2); color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; }
    `,w.appendChild(I);let m=document.createElement("button");m.className="btn",m.setAttribute("aria-label","Abrir chat"),m.innerHTML=`<svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M21 12c0 4.418-4.03 8-9 8-1.003 0-1.966-.146-2.86-.416L3 20l1.52-4.28C4.191 14.79 4 13.915 4 13c0-4.418 4.03-8 9-8s9 3.582 9 7z"
        stroke="white" stroke-width="1.5" fill="none"/></svg>`,w.appendChild(m);let r=document.createElement("div");r.className="panel",r.innerHTML=`
      <div class="header">
        <div>Chat con Crussader</div>
        <button class="close">Cerrar</button>
      </div>
      <div class="body">
        <div class="msgs" id="msgs"></div>
        <div class="input">
          <input id="msgInput" placeholder="Escribe tu mensaje..." />
          <button id="sendBtn">Enviar</button>
        </div>
      </div>
    `,w.appendChild(r);let S=r.querySelector("#msgs"),v=r.querySelector("#msgInput"),_=r.querySelector("#sendBtn"),M=r.querySelector(".close"),h=!1;function y(){h||(r.style.display="block",h=!0)}function E(){h&&(r.style.display="none",h=!1)}function i(e,t){let n=document.createElement("div");n.className="row "+e;let c=document.createElement("div");c.className="bubble",c.textContent=t,n.appendChild(c),S.appendChild(n),S.scrollTop=S.scrollHeight}m.addEventListener("click",()=>h?E():y()),M.addEventListener("click",E),(async()=>{try{let e=await l.bootstrap(o);if(b=e.site.id,await l.ensureSessionByKey(o),e.allowPrivate&&e.user){let t=e.user.name||e.user.email||"usuario",n=e.company?.plan??"free",c=e.counts?.locations??0,p=e.responseSettings?.configured?"\u2705 voz de marca configurada":"\u26A0\uFE0F voz de marca sin configurar";y(),i("bot",`\xA1Hola ${t}! \u{1F44B}`),i("bot",`Est\xE1s en ${e.company?.name??"tu empresa"} \xB7 plan: ${n} \xB7 ubicaciones: ${c} \xB7 ${p}.`),i("bot","\xBFEn qu\xE9 te ayudo? Puedo guiarte para configurar el webchat o tus respuestas.")}else{let t=e.site?.settings?.greeting;t&&(y(),i("bot",t))}}catch(e){console.error("[webchat] init error:",e)}})();async function k(){let e=(v.value||"").trim();if(e){i("user",e),v.value="";try{let t=await l.sendUserMessage(e);t?.botMessage?.text&&i("bot",t.botMessage.text)}catch(t){console.error("[webchat] send error:",t),i("bot","\u26A0\uFE0F No he podido enviar tu mensaje ahora mismo.")}}}_.addEventListener("click",k),v.addEventListener("keydown",e=>{e.key==="Enter"&&k()});function C(e,t){switch(e){case"open":y();break;case"close":E();break;case"identify":i("bot","\u2705 Usuario: "+JSON.stringify(t));break;case"message":t?.text&&i(t.role==="user"?"user":"bot",t.text);break;default:console.warn("[crussaderChat] comando desconocido:",e)}}a.forEach(e=>C(e[0],e[1])),window.crussaderChat=C,console.info("[crussaderChat] Widget cargado")})})();return B(P);})();
//# sourceMappingURL=index.global.js.map